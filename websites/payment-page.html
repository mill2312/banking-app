<!DOCTYPE html>
<head>
    <title>Payment</title>
</head>
<body>
    You are logged in as <span id="username" style="font-weight: bold;"></span><br>
    Balance is <span id="balance" style="font-weight: bold;"></span> <br>
    <button id="logout-button">Log Out</button>
    

    <br>
    <h1>Payments</h1><br>
    Send to User<br>

    
    <label for="username-input-send">Username</label>
    <input id="username-input-send">


    
    <label for="amount-input-send">Amount</label>
    <input id="amount-input-send">
    
    
    <button id="send-button">Send</button>

    <br>

    Request from user<br>
    <label for="username-request">Username</label>
    <input id="username-request">


    
    <label for="amount-request">Amount</label>
    <input id="amount-request">

    <button id="request-button">Request</button>

    <button id="pending-requests-button">See Pending Requests</button>
    </br>

</body>
<script src="/client-functions.js"></script>

<script> 

    //Request from User<br>
    //  Username: <input><br>
    //Amount: <input><br>
    //<button>Request</button>
    // //<button id="logout-button">Log Out</button> earlier

    // const logoutbutton = document.createElement("Button");
    // logoutbutton.innerHTML = "Log Out";
    // document.body.appendChild(logoutbutton);

    var logoutButton = document.getElementById("logout-button")

    const sendButton = document.getElementById("send-button")

    const requestButton = document.getElementById("request-button")

    const seeRequests = document.getElementById("pending-requests-button")
    
    //sendbutton.innerHTML = "Send Money";
    //document.body.appendChild(sendbutton);

    logoutButton.addEventListener("click", async function() {
        alert("signing out");
        var sessionIdValue = getCookie("sessionId")
        let result = await makeServerRequest("log-out", {sessionId: sessionIdValue})
        if(result.success == true){
            window.location.href = "/login"
        } else {
            alert(result.message)
        }

    })

    seeRequests.addEventListener("click", async function() {
        alert("Here are the requests");
        var sessionIdValue = getCookie("sessionId")
        let result = await makeServerRequest("get-last-10-transactions", {sessionId: sessionIdValue})
        if(result.success == true){
        window.location.href = "/inspector" //or where the list will be
        } else {
            alert(result.message)
        }

    })

    async function setUserName() {
        var usernameElement = document.getElementById("username")
        var balanceElement = document.getElementById("balance")
        var sessionId = getCookie("sessionId")
        //wait()

        let returned = await makeServerRequest("get-user-info",{sessionId : sessionId})
        console.log(returned)
        let username = returned.username
        let balance = returned.balance

        usernameElement.innerHTML = username
        balanceElement.innerHTML = "$" + balance

    }
    

   // document.getElementbyID("logout-button").addEventListener("click", function() {
//        console.log("Logging Out");
            //app.get("/login", function(req,res)
            //window.location.href = "/log-out"
       // });

    setUserName()

    

    sendButton.addEventListener("click", function() {
        //alert("here"); works
        console.log("Sending Money");
            //app.get("/login", function(req,res)
            //window.location.href = "/log-out"
            sendMoney(document.getElementById("username-input-send").value, document.getElementById("amount-input-send").value )

    })

    requestButton.addEventListener("click", function() {
        alert("requesting money"); //works
        console.log("Request Sent");
            //app.get("/login", function(req,res)
            //window.location.href = "/log-out"
            requestMoney(document.getElementById("username-request").value, document.getElementById("amount-request").value )

    })


    /*
    document.getElementbyID("send-button").addEventListener("click", async function() {
            console.log("Sening Money");
            //app.get("/login", function(req,res)
            //window.location.href = "/log-out"
            sendMoney(document.getElementbyId("username"), document.getElementbyId("username-input-send"), document.getElementbyId("amount-input-send") )
        });
    */


    async function sendMoney(targetName, money) {

        let sessionId = getCookie("sessionId")
        user = document.getElementById("username-input-send")


        if (!user) {
            console.log("sender does not exist")
            return;
        }

        if (!targetName) { // If not target Id (or if wrong)
            return;
        }

        if (user.balance < money) {
            console.log("not enough money")
            return;
        }

        //Can try to use a try-catch, dont want to risk it
        // datastores/userData.db
        console.log(targetName)
        response = await makeServerRequest("pay", {
            toUsername:  targetName,
            sessionId: getCookie("sessionId"),
            amount: money,
        })
        //alert(sessionId);

        console.log(response)
        if (response.success == true) {
            //alert('here');
            console.log('success');
            setUserName();
        }
        console.log(`Successfully sent $${money} from ${user} to ${targetName}.`);
    }

    async function requestMoney(targetName, money) {
        let sessionId = getCookie("sessionId");
        user = document.getElementById("username-input-send")

        if (!targetName) {
            alert('user does not exist')
            return;
        }

        response = await makeServerRequest("request", {
            toUsername:  targetName,
            sessionId: getCookie("sessionId"),
            amount: money,
        })

        if (response.success == true) {
            //alert('here');
            console.log('success');
        }

        
        console.log(`Successfully recieved $${money} from ${targetName}.`);

    }
     
</script>

