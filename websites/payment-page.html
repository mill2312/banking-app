<!DOCTYPE html>
<head>
    <title>Payment</title>
</head>
<body>
    You are logged in as <span id="username" style="font-weight: bold;">username</span>
    <button id="logout-button">Log Out</button>
    

    <br>
    <h1>Payments</h1><br>
    Send to User<br>

    
    <label for="username-input-send">Username</label>
    <input id="username-input-send">


    
    <label for="amount-input-send">Amount</label>
    <input id="amount-input-send">
    
    
    <button id="send-button">Send</button>

    <br>

    Request from User<br>
    Username: <input><br>
    Amount: <input><br>
    <button>Request</button>

</body>
<script src="/client-functions.js"></script>

<script> 

// //<button id="logout-button">Log Out</button> earlier

    // const logoutbutton = document.createElement("Button");
    // logoutbutton.innerHTML = "Log Out";
    // document.body.appendChild(logoutbutton);

    var logoutButton = document.getElementById("logout-button")


    const sendbutton = document.createElement("Button");
    sendbutton.innerHTML = "Send Money";
    document.body.appendChild(sendbutton);

    logoutButton.addEventListener("click", async function() {
        alert("signing out");
        var sessionIdValue = getCookie("sessionId")
        let result = await makeServerRequest("log-out", {sessionId: sessionIdValue})
        if(result.success == true){
            window.location.href = "/login"
        } else {
            alert(result.message)
        }

    })

    async function setUserName() {
        var usernameElement = document.getElementById("username")
        var sessionId = getCookie("sessionId")
        //wait()

        let returned = await makeServerRequest("get-user-info",{sessionId : sessionId})
        console.log(returned)
    }

   // document.getElementbyID("logout-button").addEventListener("click", function() {
//        console.log("Logging Out");
            //app.get("/login", function(req,res)
            //window.location.href = "/log-out"
       // });

    setUserName()

    

    sendbutton.addEventListener("click", function() {
        //alert("here"); works
        console.log("Sending Money");
            //app.get("/login", function(req,res)
            //window.location.href = "/log-out"
            sendMoney(document.getElementbyId("username"), document.getElementbyId("username-input-send"), document.getElementbyId("amount-input-send") )

    })


    /*
    document.getElementbyID("send-button").addEventListener("click", async function() {
            console.log("Sening Money");
            //app.get("/login", function(req,res)
            //window.location.href = "/log-out"
            sendMoney(document.getElementbyId("username"), document.getElementbyId("username-input-send"), document.getElementbyId("amount-input-send") )
        });
    */

    setUserName()

    async function sendMoney(userId, targetId, amount) {
        if (!sender) {
            console.log("sender does not exist")
            return;
        }

        if (!targetId) { // If not target Id (or if wrong)
            return;
        }

        if  (sender.balance < amount) {
            console.log("not enough money")
            return;
        }

        //Can try to use a try-catch, dont want to risk it
        datastores/userData.db
        await fetch(`/api/users/${senderId}/updateBalance`, {
            method : 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({amount: -money}),

        });
        await fetch(`/api/users/${recevierId}/updateBalance`, {
            method : 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({amount: money}),

        });
        console.log(`Successfully sent $${money} from ${senderId} to ${receiverId}.`);
    }
     
</script>

