<!DOCTYPE html>
<head>
    <title>Requests</title>
    

</head>
<body>
    <br> You are logged in as <span id="username" style="font-weight: bold;"></span> <br>
    Balance is <span id="balance" style="font-weight: bold;"></span> <br>


    

    
    <button id="logout-button">Log Out</button>
    <button id="payment-page-button">Go Back</button>
    <button id="see-requests-button" hidden>See Requests</button>
    <button id="accept-deny-button" hidden>Accept/Deny Requests</button>
    <br>
    <br>
    <div id="requests-area">
        
    </div>

</body>

<script src="/client-functions.js"></script>
<script>

    setUserNameAndBalance()
    getRequestsList()
    //find(username)
    //seeTransactions();

    const logoutButton = document.getElementById("logout-button")

    const paymentPageButton = document.getElementById("payment-page-button")

    const requestPageButton = document.getElementById("see-requests-button")

    //const acceptDenyButton = document.getElementById("accept-deny-button")

    logoutButton.addEventListener("click", async function() {
        alert("signing out");
        var sessionIdValue = getCookie("sessionId")
        window.location.href = "/login"
        

    })

    paymentPageButton.addEventListener("click", async function() {
        //alert("Returning to Payment Page");
        var sessionIdValue = getCookie("sessionId")
        //let result = await makeServerRequest("payment-page", {sessionId: sessionIdValue})
        window.location.href = "/payment-page"
    })


     async function getRequestsList() {
        var sessionIdValue = getCookie("sessionId")
        //let result = await makeServerRequest("payment-page", {sessionId: sessionIdValue})
        let response = await makeServerRequest("list-requests-for-user", {sessionId: sessionIdValue})
        console.log(response)
        if(!response.success){
            alert(response.message)
            return;
        }
        let tempHtml = ""
        for(let request of response.requests){
            tempHtml += `
                <div style="border:1px solid black;margin-bottom:8px;width:400px">
                    <b>$${request.amount}</b> requested from user <b>${request.sender}</b><br>
                    Time of Request: ${new Date(request.time).toLocaleString("en-US")}

                    <button onclick="acceptRequest('${request.paymentId}')">Accept</button>
                    <button onclick="denyRequest('${request.paymentId}')">Deny</button>
                </div>
            `
            /*
                What we're receiving:

                    sender: usersList.find(function(obj){return obj._id == paymentObj.senderId}).username,
                    receiver: usersList.find(function(obj){return obj._id == paymentObj.receiverId}).username,
                    amount: paymentObj.amount,
                    approved: paymentObj.approved,
                    time: new Date(paymentObj.time)
            */
        }

        document.getElementById("requests-area").innerHTML = tempHtml



        //window.location.href = "/payment-page"
    }

    /**
     * Accepts the request with the given ID
     */
    async function acceptRequest(paymentId){
        var response = await makeServerRequest("accept-deny-request", {sessionId: getCookie("sessionId"), paymentId: paymentId, accept: true} )
        if(response.success){
            alert("Successfully accepted request. Refreshing page.")
            location.reload()
        }
    }

    /**
     * Declines the request with the given ID
     */
    async function denyRequest(paymentId){
        var response = await makeServerRequest("accept-deny-request", {sessionId: getCookie("sessionId"), paymentId: paymentId, accept: false} )
        if(response.success){
            alert("Successfully accepted request. Refreshing page.")
            location.reload()
        }
    }

    /*
    acceptDenyButton.addEventListener("click", async function() {
        alert("Choose to Accept or Deny these requests");
        var sessionIdValue = getCookie("sessionId")
        //let result = await makeServerRequest("payment-page", {sessionId: sessionIdValue})
        var paymentIdValue = getPayment()
        var choice = true

        // Would I need to do something for for (request:getLast10Transaction()) ?
        let result = await makeServerRequest("accept-deny-request", {sessionId: sessionIdValue}, {}, {accept: True})
        //window.location.href = "/payment-page"
    })
    */

    
    



    //paymentsdb
    //check if reciever ID is you

    //get-last-10-transactions(username)


    async function seeTranactions() {
        var usernameElement = document.getElementById("get-last-10-transactions")

    //<!-- #region 
    //Want to search payments where accept is null, then print in order
    //-->
    //print(get-last-10-transactions)
        print(usernameElement)
        var sessionId = getCookie("sessionId")
    }

async function setUserNameAndBalance() {
        var usernameElement = document.getElementById("username")
        var balanceElement = document.getElementById("balance")
        var sessionId = getCookie("sessionId")
        //wait()

        let returned = await makeServerRequest("get-user-info",{sessionId : sessionId})
        console.log(returned)
        let username = returned.username
        let balance = returned.balance

        usernameElement.innerHTML = username
        balanceElement.innerHTML = "$" + balance

    }

</script>
